# Architectural Proposal: Scalable Customer Segmentation System
**Version:** 2.0  
**Target Scale:** 1 Million+ Records / High Concurrency  
**Date:** October 26, 2023

---

## 1. Executive Summary
The current single-server PHP implementation of the Customer Segmentation Dashboard is insufficient for handling datasets larger than 50,000 records. To support **1 million customer records** and **concurrent user access**, the system must migrate from a synchronous, monolithic architecture to an **asynchronous, distributed worker architecture**.

## 2. Current Bottlenecks
| Component | Issue | Impact with 1M Records |
| :--- | :--- | :--- |
| **Memory** | `fetchAll()` loads all rows into RAM. | **Fatal Error**: Exceeds 256MB limit immediately. |
| **CPU** | Synchronous K-Means calculation. | **Timeout**: Script hangs for minutes/hours; blocks other users. |
| **Database** | Single transaction for results. | **Locking**: Database becomes unresponsive during write operations. |
| **Process** | `set_time_limit(0)` | **Stability**: Risk of zombie processes and server thread exhaustion. |

---

## 3. Proposed Architecture
The new system decouples the **Web Tier** (User Interface) from the **Processing Tier** (Data Analysis) using a Message Queue.

### System Diagram
```mermaid
graph TD
    %% LAYERS
    subgraph Clients
        User[User / Browser]
    end

    subgraph Web_Tier [Web Tier - Stateless]
        LB[Load Balancer]
        Web[PHP Web Servers]
        WSS[WebSocket Server]
    end

    subgraph Data_Tier [Data Persistence]
        Redis[(Redis Cache & Session)]
        DB_Read[(MySQL Read Replica)]
        DB_Write[(MySQL Primary)]
    end

    subgraph Worker_Tier [Async Processing]
        Queue[RabbitMQ / SQS]
        Worker[Python/Spark Workers]
    end

    %% FLOW
    User -->|HTTPS| LB
    LB --> Web
    Web -->|1. Push Job| Queue
    Web -->|Read Data| DB_Read
    
    Queue -->|2. Pull Task| Worker
    Worker -->|3. Fetch Data| DB_Read
    Worker -->|4. Save Clusters| DB_Write
    DB_Write -.->|Replication| DB_Read
    
    Worker -->|5. Notify Completion| Redis
    Redis -->|6. Trigger Event| WSS
    WSS -->|7. Update UI| User
